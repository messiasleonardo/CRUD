name: CI/CD with Pull Requests

on:
  push:
    branches: [ feature/*, develop, release/*, master ]
  pull_request:
    branches: [ develop, release/*, master ]

jobs:
  build:

    runs-on: ubuntu-latest

    strategy:
      matrix:
        dotnet: ['6.0']

    steps:
    - uses: actions/checkout@v2

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: ${{ matrix.dotnet }}

    - name: Install dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --configuration Release --no-restore

    - name: Test
      run: dotnet test --no-restore --verbosity normal

    - name: Publish
      run: dotnet publish --configuration Release --no-build

    - name: Create Pull Request to Develop
      if: github.ref == 'refs/heads/feature/*'
      uses: repo-sync/pull-request@v2
      with:
        destination_branch: "develop"
        pr_title: "Pull request from feature to develop"
        pr_body: "This is an automated pull request."

    - name: Create Pull Request to Release
      if: github.ref == 'refs/heads/develop'
      uses: repo-sync/pull-request@v2
      with:
        destination_branch: "release/${{ github.run_number }}"
        pr_title: "Pull request from develop to release"
        pr_body: "This is an automated pull request."

    - name: Create Pull Request to Master
      if: github.ref == 'refs/heads/release/*'
      uses: repo-sync/pull-request@v2
      with:
        destination_branch: "master"
        pr_title: "Pull request from release to master"
        pr_body: "This is an automated pull request."
